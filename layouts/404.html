{{/*
  This template gets (ab)used to show individual micro blogs!

  Pattern:
  - Parse the URL to find the requested "id"
  - Fetch the list of micro blogs
  - Find the matching ID
  - Exists?
    - Yes: display contents
    - No: 404 page
*/}}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
      {{ block "title" . }}
        {{ with .Params.Title }}
          {{ . }} | 
        {{ end }}
        {{ .Site.Title }}
      {{ end }}
    </title>
    <meta name="viewport" content="width=device-width,minimum-scale=1" />
    <meta
      name="description"
      content="{{ with .Description }}{{ . }}{{ else }}{{if .IsPage}}{{ .Summary }}{{ else }}{{ with .Site.Params.description }}{{ . }}{{ end }}{{ end }}{{ end }}"
    />
    {{ hugo.Generator }}
    <meta name="robots" content="index, follow" />
    {{/* NOTE: These Hugo Internal Templates can be found starting at
    https://github.com/gohugoio/hugo/tree/master/tpl/tplimpl/embedded/templates */}}
    {{- template "_internal/opengraph.html" . -}}
    {{- template "_internal/schema.html" . -}}
    <link rel="stylesheet" href="/style.css" />
    {{/* fancier option demonstrated here
    https://github.com/theNewDynamic/gohugo-theme-ananke/blob/a1a99cf12681ad95b006e648a28139e6b9b75f09/layouts/_default/baseof.html#L27-L32 */}}
    <link
      href="index.xml"
      rel="alternate"
      type="application/rss+xml"
      title="{{ $.Site.Title }}"
    />
    <link
      href="index.xml"
      rel="feed"
      type="application/rss+xml"
      title="{{ $.Site.Title }}"
    />
  </head>

  <body>
    <!-- Header -->
    <div class="flex-row h-123">
      <div class="bg-custom-img h-100 flex-basis-100"></div>
      <div class="flex-column justify-center border monospace abs-w-360" style="flex-basis: 100%;">
        <h1 class="margin-05 text-align-center font-weight-400 font-size-24">{{ .Site.Title }}</h1>
        <div class="flex-row justify-center w-100">
          <a href="/" class="justify-center padding-1 flex-basis-50 border-top border-right">Blog</a>
          <a href="https://ericyd.com" class="justify-center padding-1 flex-basis-50 border-top">Homepage</a>
        </div>
      </div>
      <div class="bg-custom-img h-100 flex-basis-100"></div>
    </div>
    <!-- /Header -->

    <article>
      <em>{{ .Params.date }}</em>

      <div id="content"></div>

      <ul>
        <li><a href="/micro">Back to micro blog</a></li>
        <li><a href="/">Back to main blog</a></li>
        <li><a href="https://ericyd.com">Back to homepage</a></li>
      </ul>
    </article>
  </body>

  <script type="text/javascript">

    /**
     * defined by layouts/micro/list.json
     * 
     * type Item = {
     *   id: string,
     *   date: {
     *     formatted: string,
     *     raw: string
     *   },
     *   permalink: string,
     *   content: string
     * }
     */
    async function fetchItems(_event) {
      const contentDiv = document.getElementById("content")
      try {
        const response = await fetch('/micro/index.json');
        const json = await response.json();
        const maybeId = window.location.pathname.split('/').filter(part => part !== '').pop()
        const maybeItem = json.items.find(i => i.id === maybeId)

        if (!maybeItem) {
          throw new Error(`Could not find micro blog with ID "${maybeId}"`)
        }

        const markdown = document.createElement('div');
        // Pretty insecure... meh ¯\_(ツ)_/¯
        markdown.innerHTML = maybeItem.content;
        const date = document.createElement('em')
        date.innerText = maybeItem.date.raw;
        contentDiv.appendChild(date);
        contentDiv.appendChild(markdown);
      } catch (e) {
        displayError(contentDiv, e);
      }
    }

    function displayError(contentDiv, error) {
      const errorText = error ? `<pre>${error.toString().replace(/\n/g, '<br />')}</pre>` : ''
      contentDiv.innerHTML = `<h1>Error loading page</h1><p>You probably messed up.</p>${errorText}`
    }

    window.addEventListener('load', fetchItems)
  </script>
</html>
